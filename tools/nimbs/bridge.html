<link rel="stylesheet" href="/css/d3.parcoords.css" type="text/css" />
<link rel="stylesheet" href="/css/ui.css" type="text/css" />
<link rel="stylesheet" href="/css/custom-theme/jquery-ui-1.9.1.custom.min.css" type="text/css"/>

<script src="/socket.io/socket.io.js"></script>
<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
<script language="javascript" type="text/javascript" src="/js/jquery.js"></script>
<script language="javascript" type="text/javascript" src="/js/jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="/js/jquery-ui-1.9.1.custom.min.js"></script>
<script language="javascript" type="text/javascript" src="/js/knockout-2.1.0.js"></script>
<script language="javascript" type="text/javascript" src="/js/d3.v2.min.js"></script>
<script language="javascript" type="text/javascript" src="/js/d3.parcoords.js"></script>


<script>
  $(document).ready(function() {
    $("#tabs").tabs();
  });
</script>



<body>
<h3 id="title">ga-bitbot streaming bridge</h3><br>





<div id="tabs">
    <ul>
        <li><a href="#tab-1"><span>Status</span></a></li>
        <li><a href="#tab-2"><span>Buttons</span></a></li>
        <li><a href="#tab-3"><span>Market Depth</span></a></li>
        <li><a href="#tab-4"><span>Explorer</span></a></li>
        <li><a href="#tab-5"><span>Calc</span></a></li>
        <li><a href="#tab-6"><span>Feed</span></a></li>
        <li><a href="#tab-7"><span>Trades</span></a></li>
        <li><a href="#tab-8"><span>PIDS</span></a></li>
        <li><a href="#tab-9"><span>Debug</span></a></li>
    </ul>
    <div id="tab-1">
	<div id="notifications">notifications go here</div> 
    </div>
    <div id="tab-2">
        <div id="menu_buttons" style="position:relative;right:-1em;">
	<input type="submit" value="Home" id="dashboard_button" class="ui-button-text">
	<input type="submit" value="Upload" id="upload_button" class="ui-button-text">
	<input type="submit" value="Search" id="search_button" class="ui-button-text">
	<input type="submit" value="Alerts" id="alerts_button" class="ui-button-text">
	<input type="submit" value="Report" id="report_button" class="ui-button-text">
	<input type="submit" value="Logs" id="logs_button" class="ui-button-text">
	<input type="submit" value="Monitor" id="monitor_button" class="ui-button-text">
	<input type="submit" value="Admin" id="admin_button" class="ui-button-text">
	</div>
    </div>
    <div id="tab-3">
	<div id="depth_plot" style="width:800px;height:300px;"></div>
    </div>
    <div id="tab-4">
	Parallel coordinate visualization of the genetic database.
	<input type="submit" value="Load" id="gene_db_reload_button" class="ui-button-text">
	<div id="explorer"></div>
	<div id="pchart"></div>
    </div>
    <div id="tab-5">
	<div id="gene_def_calc"><h3>gene data definition calculator</h3><BR>
	BITS<input type="text" value="8" id="bits">
	DECIMAL<input type="text" value="2" id="decimal">
	OFFSET<input type="text" value="0" id="offset">
	<input type="submit" value="Calculate" id="calc_button" class="ui-button-text">
	<span id="calc_result"></span>
	</div>
    </div>
    <div id="tab-6">
	<div id="mtgox_feed"></div>
    </div>
    <div id="tab-7">
	<div id="trades">trades</div>
	<div id="ticker">ticker</div>
	<div id="depth">depth</div>
    </div>
    <div id="tab-8">
	<div id="pids"></div>
    </div>
    <div id="tab-9">
	<span id="debug">debug area</span>
    </div>

</div>


</body>
<script>
	var ch_depth = '24e67e0d-1cad-4cc0-9e7a-f8523ef460fe';
	var ch_trades = 'dbf1dee9-4f2e-4a08-8cb7-748919a71b21';
	var ch_ticker = 'd5f06780-30a8-4a48-a2f8-7ed181b4a13f';
	var bid_depth = {};
	var ask_depth = {};
	var gene_db = {};
	var gene_db_data_array = new Array();
	var pc;	//parrallel coord chart object
	var spread = 0.025;
	var plot_x_center = 2.0;
	var conn = io.connect(window.location.hostname + ':8088/ga_bitbot');



	// setup plot
	var options = {
		series: { shadowSize: 0 }, // drawing is faster without shadows
		yaxis: { min: 0, max: 800 },
		xaxis: { show: true }
	};
	
	var plot = $.plot($("#depth_plot"), [ [0,0] ], options);

	function getDepth(depth_dict,center_price,center_spread) {
		var res = [];
		for (key in depth_dict){
			if(depth_dict.hasOwnProperty(key)){
				if ( (parseFloat(key) > center_price * (1 - center_spread)))
				{
					if ( (parseFloat(key) < center_price * (1 + center_spread)))
					{
						res.push([parseFloat(key), parseFloat(depth_dict[key])])
					}
				}
			}
		}
        	return res;
	}


	conn.on('connect',    onConnect);
	conn.on('disconnect', onDisconnect);
	conn.on('error',      onError);
	conn.on('message',    onMessage);

	function onConnect(msg)
	{
		if (this.socket.connected) {
			$('#notifications').html("connected<br>");
			//sub = {"channel":ch_depth, "op":"subscribe"};
			//this.send(sub);
		}
	}
	function onError(msg)
	{
		$('#notifications').html(conn.result);
	}
	function onDisconnect(msg)
	{
		$('#notifications').html("disconnected<br>");
	}
	function onMessage(msg)
	{
		if (msg.channel == 'full_ask')
		{
			ask_depth = msg.depth;
		}
		if (msg.channel == 'full_bid')
		{
			bid_depth = msg.depth;
			//$('#debug').html(JSON.stringify(msg.depth));
		}
		if (msg.channel == '1min')
		{
			//$('#debug').append(JSON.stringify(msg) + '<BR>');
		}
		if (msg.channel == 'gene_db')
		{
			//$('#debug').html(JSON.stringify(msg.value) + '<BR>');
			gene_db = msg.value;

			//debug...
			dim_array = new Array();
			//dim_array.push('db_index');
			dim_array.push("buy_wait");
			dim_array.push("buy_wait_after_stop_loss");
			dim_array.push("wls");
			dim_array.push("wll");
			dim_array.push("macd_buy_trip");
			dim_array.push("markup");
			dim_array.push("stop_loss");
			dim_array.push("score");

			//create an array of checkboxes to select from
			for (var key in Object.keys(gene_db)){
				
			}
			//clear the chart area
			try{$('#pchart').accordion("destroy");}catch(err){};
			$("#pchart").html("");
			//$("#pchart").removeClass();

			var db_index = 0
			for (var db_lib in gene_db){ 
				console.log(db_lib);
				var gene_db_data_array = new Array();
				var gene_db_library_id = Object.keys(gene_db)[db_index]
				
				for (var i = 0; i < gene_db[db_lib]["gene_high_scores"].length; i++)
				{
					gene_db[db_lib]["gene_high_scores"][i].forEach(function (db_record)
					{ 					
						data_array = new Array();
						//data_array.push(db_index);
						data_array.push(db_record["buy_wait"]);
						data_array.push(db_record["buy_wait_after_stop_loss"]);
						data_array.push(db_record["wls"]);
						data_array.push(db_record["wll"]);
						data_array.push(db_record["macd_buy_trip"]);
						data_array.push(db_record["markup"]);
						data_array.push(db_record["stop_loss"]);
						data_array.push(db_record["score"]);

						db_record['db_index'] = db_index;

						//$('#debug').append(data_array.join() + '<BR>');
						if (db_record["score"] > 0.0)
						{
							gene_db_data_array.push(db_record); //data_array
							//ts = new Date(db_record['time'] * 1000);
							//if (i == 3) {console.log(db_record['id']+' : '+ db_record['score']+' : '+ts+' : '+i);}
						}

					});

					//$('#explorer').html("This text comes before the chart<BR>");
					if ((gene_db[db_lib]['gene_def'] != "UNDEFINED") && (gene_db_data_array.length > 0)){
						$("#pchart").append("<h3>"+$.parseJSON(gene_db[db_lib]['gene_def'])['name']+" Quartile: " +(i+1)+"</h3>");
						$("#pchart").append('<div id="dpc_'+gene_db_library_id+'_'+i+'"><p id="pchart_'+gene_db_library_id+'_'+i+'" class="parcoords" style="height:200px"></p>');
						//$("#pchart_"+ gene_db_library_id+'_'+i).html("<h3>"+$.parseJSON(gene_db[db_lib]['gene_def'])['name']+" Quartile: " +(i+1)+"</h3><BR>");
				
						pc = d3.parcoords()("#pchart_"+ gene_db_library_id+'_'+i)
							.data(gene_db_data_array)
							.dimensions(dim_array)
							.alpha(0.40)
							.color("#400800")
							.mode("queue")
							.composite("lighter")
							.rate(5)
							.render()
							.createAxes()
							.brushable()
							.reorderable();
						//$("#pchart_"+ gene_db_library_id+'_'+i).append("</p>");
						$("#dpc_"+ gene_db_library_id+'_'+i).append('<fieldset id="fs_'+gene_db_library_id+'_'+i+'" ></fieldset>');
						
						JSON.parse(gene_db[db_lib]['gene_def'])['call']['add_numvar'].forEach(function(item){

							$("#fs_"+ gene_db_library_id+'_'+i).append($(document.createElement("input")).attr({
							    			 id:	'cb_'+ item[0] + '_' + gene_db_library_id + '_' + i
							    			,type:	'checkbox'
							    			,checked:true
							    		}));

							$("#fs_"+ gene_db_library_id+'_'+i).append($(document.createElement("label")).attr({
							    			 id:	'label_'+ item[0] + '_' + gene_db_library_id + '_' + i
							    			,for:	'cb_'+ item[0] + '_' + gene_db_library_id + '_' + i
							    		}));

							$('#label_'+ item[0] + '_' + gene_db_library_id + '_' + i).html(item[0]);
							
							$("#fs_"+ gene_db_library_id+'_'+i).append('<br>');

						});
						//$('#fs_'+gene_db_library_id+'_'+i).buttonset();
						$("#pchart_"+ gene_db_library_id+'_'+i).append("</div><BR>");

					}
				}
				var db_index = db_index + 1;
			};
			$('#pchart').accordion();

		}
		if (msg.channel == 'pids')
		{
			//console.log(msg);
			$('#pids').html('');
			for (key in msg.value){
				//console.log(key);
				if(msg.value[key].hasOwnProperty('msg_buffer'))
				{
					$('#pids').append(key + ' :: ');
					//console.log(msg.value[key].msg_buffer);
					$('#pids').append(msg.value[key].msg_buffer.split('\n').reverse()[1] + '<BR>');
				}
			}
		}

		if (msg.channel == ch_depth)
		{
			if (msg.depth.type_str == 'bid')
			{
				bid_depth[msg.depth.price] = parseFloat(msg.depth.total_volume_int) / 100000000.0;
			}
			if (msg.depth.type_str == 'ask')
			{
				ask_depth[msg.depth.price] = parseFloat(msg.depth.total_volume_int) / 100000000.0;
			}
			$('#depth').html(msg.depth.type_str + ': price $'+ parseFloat(msg.depth.price).toFixed(3) + "  amount " + parseFloat(msg.depth.volume).toFixed(3) + '<br>');
		}

		if (msg.channel == ch_trades)
		{
			//plot_x_center = msg.trade.price;
			$('#trades').html(' price: ' + msg.trade.price + '  amount: ' + msg.trade.amount + '<br>');
		}

		if (msg.channel == ch_ticker)
		{
			plot_x_center = msg.ticker.buy.value;
			$('#ticker').html('buy: ' + msg.ticker.buy.display +'  sell: ' + msg.ticker.sell.display + '<br>');
		}

	}


	function updatePlot()
	{
		plot.setData([ {data: getDepth(ask_depth,plot_x_center,spread),bars: { show: true,barWidth: 0.001 }},{data: getDepth(bid_depth,plot_x_center,spread),bars: { show: true,barWidth: 0.001 }}]);
		plot.setupGrid()
		plot.draw();
	}


	// periodic timers
	setInterval(updatePlot, 10000); //10 second interval


	//UI events
	$("#calc_button").click(function() {
		bits = Math.pow(2,parseInt($("#bits").val()));
		dec = 1.0 / Math.pow(10,parseInt($("#decimal").val()));
		offset = parseFloat($("#offset").val());
		mx = (bits * dec) + offset;
		$("#calc_result").html(
			"<br>resolution: " + bits + '<BR>' +
			"div: " + dec + '<BR>' +  
			"min: " + offset + '<BR>' + 
			"max: " + mx + '<BR>'
		);
	});


	$("#gene_db_reload_button").click(function() {
  		conn.emit('request_gene_db',{});
	});



</script>


