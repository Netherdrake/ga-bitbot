<link rel="stylesheet" href="/css/ui.css" type="text/css" />
<link href="/css/custom-theme/jquery-ui-1.9.1.custom.min.css" rel="stylesheet" type="text/css"/>
<script src="/socket.io/socket.io.js"></script>
<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
<script language="javascript" type="text/javascript" src="/js/jquery.js"></script>
<script language="javascript" type="text/javascript" src="/js/jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="/js/jquery-ui-1.9.1.custom.min.js"></script>
<script language="javascript" type="text/javascript" src="/js/knockout-2.1.0.js"></script>


<script>
  $(document).ready(function() {
    $("#tabs").tabs();
  });
</script>



<body>
<h3 id="title">ga-bitbot streaming bridge</h3><br>





<div id="tabs">
    <ul>
        <li><a href="#tab-1"><span>Status</span></a></li>
        <li><a href="#tab-2"><span>Buttons</span></a></li>
        <li><a href="#tab-3"><span>Market Depth</span></a></li>
        <li><a href="#tab-4"><span>Content</span></a></li>
        <li><a href="#tab-5"><span>Calc</span></a></li>
        <li><a href="#tab-6"><span>Feed</span></a></li>
        <li><a href="#tab-7"><span>Trades</span></a></li>
        <li><a href="#tab-8"><span>PIDS</span></a></li>
        <li><a href="#tab-9"><span>Debug</span></a></li>
    </ul>
    <div id="tab-1">
	<div id="notifications">notifications go here</div> 
    </div>
    <div id="tab-2">
        <div id="menu_buttons" style="position:relative;right:-1em;">
	<input type="submit" value="Home" id="dashboard_button" class="ui-button-text">
	<input type="submit" value="Upload" id="upload_button" class="ui-button-text">
	<input type="submit" value="Search" id="search_button" class="ui-button-text">
	<input type="submit" value="Alerts" id="alerts_button" class="ui-button-text">
	<input type="submit" value="Report" id="report_button" class="ui-button-text">
	<input type="submit" value="Logs" id="logs_button" class="ui-button-text">
	<input type="submit" value="Monitor" id="monitor_button" class="ui-button-text">
	<input type="submit" value="Admin" id="admin_button" class="ui-button-text">
	</div>
    </div>
    <div id="tab-3">
	<div id="depth_plot" style="width:800px;height:300px;"></div>
    </div>
    <div id="tab-4">
	<div id="content"></div>
    </div>
    <div id="tab-5">
	<div id="gene_def_calc"><h3>gene depth calculator</h3><BR>
	BITS<input type="text" value="8" id="bits">
	DECIMAL<input type="text" value="2" id="decimal">
	OFFSET<input type="text" value="0" id="offset">
	<input type="submit" value="Calculate" id="calc_button" class="ui-button-text">
	<span id="calc_result"></span>
	</div>
    </div>
    <div id="tab-6">
	<div id="mtgox_feed"></div>
    </div>
    <div id="tab-7">
	<div id="trades">trades</div>
	<div id="ticker">ticker</div>
	<div id="depth">depth</div>
    </div>
    <div id="tab-8">
	<div id="pids"></div>
    </div>
    <div id="tab-9">
	<span id="debug">debug area</span>
    </div>

</div>


</body>
<script>
	var ch_depth = '24e67e0d-1cad-4cc0-9e7a-f8523ef460fe';
	var ch_trades = 'dbf1dee9-4f2e-4a08-8cb7-748919a71b21';
	var ch_ticker = 'd5f06780-30a8-4a48-a2f8-7ed181b4a13f';
	var bid_depth = {};
	var ask_depth = {};
	var spread = 0.025;
	var plot_x_center = 2.0;
	var conn = io.connect(window.location.hostname + ':8088/ga_bitbot');



	// setup plot
	var options = {
		series: { shadowSize: 0 }, // drawing is faster without shadows
		yaxis: { min: 0, max: 800 },
		xaxis: { show: true }
	};
	
	var plot = $.plot($("#depth_plot"), [ [0,0] ], options);

	function getDepth(depth_dict,center_price,center_spread) {
		var res = [];
		for (key in depth_dict){
			if(depth_dict.hasOwnProperty(key)){
				if ( (parseFloat(key) > center_price * (1 - center_spread)))
				{
					if ( (parseFloat(key) < center_price * (1 + center_spread)))
					{
						res.push([parseFloat(key), parseFloat(depth_dict[key])])
					}
				}
			}
		}
        	return res;
	}


	conn.on('connect',    onConnect);
	conn.on('disconnect', onDisconnect);
	conn.on('error',      onError);
	conn.on('message',    onMessage);

	function onConnect(msg)
	{
		if (this.socket.connected) {
			$('#notifications').html("connected<br>");
			//sub = {"channel":ch_depth, "op":"subscribe"};
			//this.send(sub);
		}
	}
	function onError(msg)
	{
		$('#notifications').html(conn.result);
	}
	function onDisconnect(msg)
	{
		$('#notifications').html("disconnected<br>");
	}
	function onMessage(msg)
	{
		if (msg.channel == 'full_ask')
		{
			ask_depth = msg.depth;
		}
		if (msg.channel == 'full_bid')
		{
			bid_depth = msg.depth;
			//$('#debug').html(JSON.stringify(msg.depth));
		}
		if (msg.channel == '1min')
		{
			$('#debug').append(JSON.stringify(msg) + '<BR>');
		}
		if (msg.channel == 'pids')
		{
			//console.log(msg);
			$('#pids').html('');
			for (key in msg.value){
				//console.log(key);
				if(msg.value[key].hasOwnProperty('msg_buffer'))
				{
					$('#pids').append(key + ' :: ');
					//console.log(msg.value[key].msg_buffer);
					$('#pids').append(msg.value[key].msg_buffer.split('\n').reverse()[1] + '<BR>');
				}
			}
		}

		if (msg.channel == ch_depth)
		{
			if (msg.depth.type_str == 'bid')
			{
				bid_depth[msg.depth.price] = parseFloat(msg.depth.total_volume_int) / 100000000.0;
			}
			if (msg.depth.type_str == 'ask')
			{
				ask_depth[msg.depth.price] = parseFloat(msg.depth.total_volume_int) / 100000000.0;
			}
			$('#depth').html(msg.depth.type_str + ': price $'+ parseFloat(msg.depth.price).toFixed(3) + "  amount " + parseFloat(msg.depth.volume).toFixed(3) + '<br>');
		}

		if (msg.channel == ch_trades)
		{
			//plot_x_center = msg.trade.price;
			$('#trades').html(' price: ' + msg.trade.price + '  amount: ' + msg.trade.amount + '<br>');
		}

		if (msg.channel == ch_ticker)
		{
			plot_x_center = msg.ticker.buy.value;
			$('#ticker').html('buy: ' + msg.ticker.buy.display +'  sell: ' + msg.ticker.sell.display + '<br>');
		}

	}


	function updatePlot()
	{
		plot.setData([ {data: getDepth(ask_depth,plot_x_center,spread),bars: { show: true,barWidth: 0.001 }},{data: getDepth(bid_depth,plot_x_center,spread),bars: { show: true,barWidth: 0.001 }}]);
		plot.setupGrid()
		plot.draw();
	}


	// periodic timers
	setInterval(updatePlot, 10000); //10 second interval


	//UI events
	$("#calc_button").click(function() {
		bits = Math.pow(2,parseInt($("#bits").val()));
		dec = 1.0 / Math.pow(10,parseInt($("#decimal").val()));
		offset = parseFloat($("#offset").val());
		mx = (bits * dec) + offset;
		$("#calc_result").html(
			"resolution: " + bits + '<BR>' +
			"div: " + dec + '<BR>' +  
			"min: " + offset + '<BR>' + 
			"max: " + mx + '<BR>'
		);
	});





</script>


